<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:lang="${userLanguage}"
      th:data-bs-theme="${userTheme}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{page.dashboard.title}">Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="dashboard-page" th:attr="data-language=${userLanguage}">

<nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand align-items-center" href="#">
            <img th:src="@{/images/Logo_.svg}" alt="Logo" class="logo-img">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav align-items-center gap-2">
                <li class="nav-item dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle btn-sm" data-bs-toggle="dropdown">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow">
                        <li><h6 class="dropdown-header" th:text="#{page.dashboard.settings.language}">Jzyk</h6></li>
                        <li>
                            <a class="dropdown-item d-flex justify-content-between align-items-center"
                               th:href="@{/dashboard(lang='pl')}"
                               th:classappend="${userLanguage == 'pl'} ? 'active'">
                                Polski <i th:if="${userLanguage == 'pl'}" class="bi bi-check"></i>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item d-flex justify-content-between align-items-center"
                               th:href="@{/dashboard(lang='en')}"
                               th:classappend="${userLanguage == 'en'} ? 'active'">
                                English <i th:if="${userLanguage == 'en'}" class="bi bi-check"></i>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header" th:text="#{page.dashboard.settings.theme}">Motyw</h6></li>
                        <li>
                            <button class="dropdown-item d-flex justify-content-between align-items-center"
                                    onclick="changeTheme('light')" data-theme-value="light"
                                    th:classappend="${userTheme == 'light'} ? 'active'">
                                <span><i class="bi me-2"></i> Light</span>
                                <i th:if="${userTheme == 'light'}" class="bi bi-check"></i>
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item d-flex justify-content-between align-items-center"
                                    onclick="changeTheme('dark')" data-theme-value="dark"
                                    th:classappend="${userTheme == 'dark'} ? 'active'">
                                <span><i class="bi me-2"></i> Dark</span>
                                <i th:if="${userTheme == 'dark'}" class="bi bi-check"></i>
                            </button>
                        </li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a th:href="@{/logout}" class="btn btn-danger btn-sm">
                        <i class="bi bi-box-arrow-right"></i> <span th:text="#{page.dashboard.logout}">Wyloguj</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container pb-5">

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body">
                    <h2 class="text-primary fw-bold" th:text="#{page.dashboard.welcome(${user.username})}">Witaj</h2>

                    <div class="alert alert-light border-start border-4 border-primary mt-3">
                        <h6 class="text-uppercase text-muted small fw-bold mb-1" th:text="#{dashboard.quote.title}">CYTAT</h6>
                        <figure class="mb-0">
                            <blockquote class="blockquote fs-6">
                                <p class="mb-0 fst-italic" th:text="${dailyQuote != null} ? ${dailyQuote} : '...'">...</p>
                            </blockquote>
                        </figure>
                    </div>

                    <div class="alert alert-info d-flex align-items-center mt-3 mb-0 p-2">
                        <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                        <div>
                            <strong th:text="#{dashboard.advice.title}">Tip:</strong>
                            <span th:text="${weatherAdvice}">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm h-100 border-0 weather-widget-bg">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div class="d-flex justify-content-between text-white">
                        <div>
                            <h4 class="mb-0 fw-bold">
                                <i class="bi bi-geo-alt"></i> <span th:text="#{dashboard.weather.current}">Pogoda</span>
                            </h4>
                            <p class="mb-0 opacity-75" th:text="${user.city}">Miasto</p>
                        </div>
                        <div class="display-4">
                            <i th:if="${#strings.contains(currentWeather.weatherType.name(), 'SUNNY')}" class="bi bi-sun-fill"></i>
                            <i th:if="${#strings.contains(currentWeather.weatherType.name(), 'CLOUDY')}" class="bi bi-cloud-fill"></i>
                            <i th:if="${#strings.contains(currentWeather.weatherType.name(), 'RAINY')}" class="bi bi-cloud-rain-fill"></i>
                            <i th:if="${#strings.contains(currentWeather.weatherType.name(), 'SNOWY')}" class="bi bi-snow"></i>
                            <i th:if="${#strings.contains(currentWeather.weatherType.name(), 'STORMY')}" class="bi bi-cloud-lightning-rain-fill"></i>
                            <i th:if="${#strings.contains(currentWeather.weatherType.name(), 'WINDY')}" class="bi bi-wind"></i>
                            <i th:if="${#strings.contains(currentWeather.weatherType.name(), 'FOGGY')}" class="bi bi-cloud-haze2-fill"></i>
                        </div>
                    </div>
                    <div class="text-center my-3 text-white">
                        <h1 class="display-1 fw-bold mb-0">
                            <span th:text="${#numbers.formatDecimal(currentWeather.temperature, 1, 1)}">20</span>掳
                        </h1>
                    </div>
                    <div class="d-flex justify-content-around text-white-50 fw-bold">
                        <span><i class="bi bi-droplet-fill"></i> <span th:text="${currentWeather.humidity}">50</span>%</span>
                        <span><i class="bi bi-speedometer"></i> <span th:text="${currentWeather.pressure}">1013</span> hPa</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body p-3">
                    <div id="calendar" th:attr="data-btn-today=#{calendar.today}"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h5 class="mb-0"><i class="bi bi-map"></i> <span th:text="#{page.dashboard.location}">Lokalizacja</span></h5>
                </div>
                <div class="card-body">
                    <div id="map" class="rounded mb-3" style="height: 200px; width: 100%;"
                         th:attr="data-city=${#strings.isEmpty(user.city) ? 'Warszawa' : user.city},
                                  data-city-custom=${!#strings.isEmpty(user.city)},
                                  data-label-user-city=#{page.dashboard.user_city},
                                  data-label-default-city=#{page.dashboard.default_city},
                                  data-label-error-loading=#{page.dashboard.error.loading}"></div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div id="cityDisplay" class="d-flex align-items-center">
                            <span class="fw-bold fs-5 me-2" th:text="${user.city}">Warszawa</span>
                            <button onclick="toggleCityEdit()" class="btn btn-link btn-sm p-0 text-decoration-none">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </div>
                    </div>

                    <div id="cityEdit" class="d-none mb-3 input-group">
                        <input type="text" id="newCityInput" class="form-control" th:value="${user.city}">
                        <button class="btn btn-success" onclick="saveCity()"><i class="bi bi-check"></i></button>
                        <button class="btn btn-outline-secondary" onclick="toggleCityEdit()"><i class="bi bi-x"></i></button>
                    </div>

                    <div class="mb-3 text-muted small">
                        <i class="bi bi-people-fill"></i>
                        <span th:text="#{dashboard.city.users.count(${usersInCity})}">Liczba os贸b: 12</span>
                    </div>

                    <div class="p-2 bg-body-tertiary rounded border mb-2 d-flex justify-content-between align-items-center">
                        <small class="text-uppercase fw-bold text-muted" th:text="#{dashboard.city.vibe.today}">Dzisiaj</small>
                        <span class="fw-bold fs-5" th:classappend="${vibeToday >= 4.0 ? 'text-success' : (vibeToday >= 2.5 ? 'text-primary' : 'text-danger')}"
                              th:text="${#numbers.formatDecimal(vibeToday, 1, 1)}">0.0</span>
                    </div>

                    <div class="p-2 bg-body-tertiary rounded border d-flex justify-content-between align-items-center">
                        <small class="text-uppercase fw-bold text-muted" th:text="#{dashboard.city.vibe.yesterday}">Wczoraj</small>
                        <span class="fw-bold fs-5 text-secondary"
                              th:text="${#numbers.formatDecimal(vibeYesterday, 1, 1)}">0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="communityStats" class="card shadow-sm border-0">
        <div class="card-header bg-transparent border-0 text-center pt-3">
            <h5 class="fw-bold text-primary" th:text="#{dashboard.stats.title}">Analiza</h5>
        </div>
        <div class="card-body">
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-body-tertiary rounded-4 p-3">
                        <h6 class="text-center text-muted mb-3" th:text="#{stats.charts.hydration.mood}">Nawodnienie vs Nastr贸j</h6>
                        <div style="height: 200px;"><canvas id="scatterHydration"></canvas></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-body-tertiary rounded-4 p-3">
                        <h6 class="text-center text-muted mb-3" th:text="#{stats.charts.pressure.mood}">Cinienie vs Nastr贸j</h6>
                        <div style="height: 200px;"><canvas id="scatterPressure"></canvas></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-body-tertiary rounded-4 p-3">
                        <h6 class="text-center text-muted mb-3" th:text="#{stats.charts.humidity.mood}">Wilgotno vs Nastr贸j</h6>
                        <div style="height: 200px;"><canvas id="scatterHumidity"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-12">
                    <div class="card h-100 border-0 bg-body-tertiary rounded-4 p-3">
                        <h6 class="text-center text-muted mb-3" th:text="#{stats.charts.personal.vs.community}">Ja vs Miasto</h6>
                        <div style="height: 300px;">
                            <canvas id="comparisonChart"
                                    th:attr="data-label-me=#{stats.label.me}, data-label-community=#{stats.label.community}">
                            </canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-body-tertiary">
                <h5 class="modal-title fw-bold" id="modalDateTitle">Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <div id="futureView" class="text-center py-5" style="display:none;">
                    <span class="display-1"></span>
                    <p class="lead text-muted mt-3" th:text="#{modal.future}">Nie wybiegaj w przyszo...</p>
                </div>

                <div id="readOnlyView" style="display:none;"
                     th:attr="data-nodata-text=#{modal.nodata},
                              data-label-weather=#{modal.label.weather}">

                    <div class="d-flex justify-content-end mb-3 gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="enableEditMode()">
                            <i class="bi bi-pencil"></i> <span th:text="#{modal.btn.edit}">Edytuj</span>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDay()">
                            <i class="bi bi-trash"></i> <span th:text="#{modal.btn.delete}">Usu</span>
                        </button>
                    </div>

                    <div class="alert alert-primary d-flex align-items-center mb-3">
                        <div class="me-auto">
                            <strong th:text="#{modal.mood}">Nastr贸j:</strong>
                            <span id="roMood" class="fw-bold ms-2"></span>
                            <span id="roMoodEmoji" class="fs-4 ms-2"></span>
                        </div>
                    </div>
                    <p id="roComment" class="fst-italic text-muted small bg-body-secondary p-2 rounded mb-3"></p>

                    <div class="row g-2 text-center mb-3">
                        <div class="col-12">
                            <div class="p-2 bg-body-tertiary rounded h-100 text-start">
                                <div class="small text-muted mb-1">
                                    <span id="roWeatherLabel">Pogoda</span> (<span id="roCity">Miasto</span>)
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div id="roWeather" class="fw-bold"></div>
                                    <div class="small text-muted">
                                        <div><i class="bi bi-droplet"></i> <span id="roHumidity"></span>%</div>
                                        <div><i class="bi bi-speedometer"></i> <span id="roPressure"></span> hPa</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 text-center">
                        <div class="col-6">
                            <div class="p-2 bg-body-tertiary rounded h-100">
                                <div class="small text-muted" th:text="#{modal.water}">Woda</div>
                                <div class="fw-bold mt-1"><span id="roWater"></span> ml</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-body-tertiary rounded h-100">
                                <div class="small text-muted" th:text="#{modal.activity}">Aktywno</div>
                                <div id="roActivity" class="fs-5 mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="editView" style="display:none;">
                    <form id="dailyLogForm">
                        <div class="mb-4">
                            <h6 class="text-primary fw-bold mb-2" th:text="#{mood.form.heading}">Nastr贸j</h6>
                            <div class="d-flex justify-content-between px-2 mb-2">
                                <div class="mood-option" th:each="i : ${#numbers.sequence(1, 5)}">
                                    <input type="radio" name="moodLevel" th:id="'mood'+${i}" th:value="${i}">
                                    <label th:for="'mood'+${i}">
                                        <i th:if="${i == 1}" class="bi bi-emoji-frown text-danger"></i>
                                        <i th:if="${i == 2}" class="bi bi-emoji-expressionless text-warning"></i>
                                        <i th:if="${i == 3}" class="bi bi-emoji-neutral text-secondary"></i>
                                        <i th:if="${i == 4}" class="bi bi-emoji-smile text-info"></i>
                                        <i th:if="${i == 5}" class="bi bi-emoji-laughing text-success"></i>
                                    </label>
                                </div>
                            </div>
                            <textarea id="commentInput" class="form-control" rows="2" th:placeholder="#{mood.form.comment.placeholder}"></textarea>
                        </div>

                        <hr class="my-3">

                        <div class="mb-4 text-center">
                            <h6 class="text-info fw-bold mb-2" th:text="#{hydration.form.title}">Nawodnienie</h6>
                            <h3 id="waterDisplay" class="text-primary fw-bold mb-2">0 ml</h3>
                            <div class="d-flex justify-content-center flex-wrap gap-2 water-container">
                                <span class="water-glass" th:each="i : ${#numbers.sequence(1, 10)}" th:data-amount="${i * 250}">
                                    <i class="bi bi-droplet-fill text-primary"></i>
                                </span>
                            </div>
                            <input type="hidden" id="hydrationInput" name="hydrationMl" value="0">
                        </div>

                        <hr class="my-3">

                        <div class="mb-4">
                            <h6 class="text-success fw-bold mb-2" th:text="#{activity.form.title}">Aktywno</h6>
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                <div th:each="type : ${T(pl.pollub.weather_mood_tracker.model.enums.ActivityType).values()}">
                                    <input type="radio" class="btn-check activity-radio"
                                           name="activity"
                                           th:id="'act-'+${type.name()}"
                                           th:value="${type.name()}"
                                           autocomplete="off">

                                    <label class="btn btn-outline-success btn-sm rounded-pill" th:for="'act-'+${type.name()}">
                                        <i th:if="${type.name() == 'WALKING'}" class="bi bi-person-walking"></i>
                                        <i th:if="${type.name() == 'RUNNING'}" class="bi bi-person-running"></i>
                                        <i th:if="${type.name() == 'CYCLING'}" class="bi bi-bicycle"></i>
                                        <i th:if="${type.name() == 'SWIMMING'}" class="bi bi-droplet"></i>
                                        <i th:if="${type.name() == 'GYM'}" class="bi bi-bricks"></i>
                                        <i th:if="${type.name() == 'YOGA'}" class="bi bi-person-arms-up"></i>
                                        <i th:if="${type.name() == 'BALLGAME'}" class="bi bi-dribbble"></i>
                                        <i th:if="${type.name() == 'OTHER'}" class="bi bi-three-dots"></i>
                                        <i th:if="${type.name() == 'NOTHING'}" class="bi bi-cup-hot"></i>

                                        <span th:text="#{activity.type.__${type.name()}__} ?: ${type.name()}">Name</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg" onclick="saveDailyLog()">
                                <i class="bi bi-save"></i> <span th:text="#{mood.form.submit}">Zapisz</span>
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/theme-manager.js}"></script>
<script th:src="@{/js/fullcalendar-init.js}"></script>
<script th:src="@{/js/location-manager.js}"></script>
<script th:src="@{/js/water-tracker.js}"></script>
<script th:src="@{/js/ajax-forms.js}"></script>
<script th:src="@{/js/charts-analytics.js}"></script>
</body>
</html>